<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="./static/style.css">
    <style>
        .no-resize {
            resize: none;
        }
        .connect-message {
            font-weight: bold;
        }
        .chat {
            margin-top: 20px;
        }
        .cellcontainer {
          margin-top: 30px;
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          grid-template-rows: 1fr 1fr 1fr;
          grid-gap: 1px 1px;
        }
        .evenodd {
          display: grid;
          grid-template-columns: 1fr 1fr;
          grid-template-rows: 1fr;
          grid-gap: 1px 1px;
        }
        .cell-1{
          grid-row: 1;
          grid-column: 1/4;
        }
        .cell-11{
          grid-row: 5;
          grid-column: 1/4;
        }
        .cell {
          color: white;
          font-size: 1rem;
          text-align: center;
          padding: 0.5rem;
        }
        .cell:hover {
          color: black;
        }
        .cell-even, .cell-odd{
          background: red;
        }
        .cell-1, .cell-11 {
          background: red;
        }
        .cell-2, .cell-3, .cell-4, .cell-8, .cell-9, .cell-10 {
          background: orange;
        }
        .cell-5, .cell-6, .cell-7 {
          background: green;
        }
        .rangediv {
          margin-left: 20px;
        }
        .rangevalue {
          position: relative;
          display: flex;
          text-align: center;
          font-size: 2em;
          color: white;
          font-weight: 400;
        }
        #rangeValue2 {
          margin-top: 150px;
        }
        .range {
          width: 100%;
          height: 15px;
          -webkit-appearance: none;
          background: #111;
          outline: none;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: inset 0 0 5px rgba(0, 0, 0, 1);
        }
        .range::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background: #4CAF50;
          cursor: pointer;
          border: 4px solid #4CAF50;
          box-shadow: -407px 0 0 400px #4CAF50;
        }
        .float-container {

        }
        .float-child {
            width: 50%;
            float: left;
        }
        #bet, #search {
          width: 100%;
          margin-top: 40px;
          margin-bottom: 40px;
          background-color: #4CAF50;
          border: none;
          color: white;
          padding: 15px 32px;
          text-align: center;
          text-decoration: none;
          display: inline-block;
          font-size: 16px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script type="text/javascript">
        var socket;
        var myId = "";
        var roomId = "";

        var placedBet = "";
        var betValue = "";

        var placedBet2 = "";
        var betValue2 = "";

        let points = {}

        function isValidUsername(username) {
            return /^[A-Za-z0-9]+$/.test(username);
        }

        function writeOnChat(text,writer){

            let chat = document.querySelector("#chatCard > .card-body")
            let autoScroll = (writer === myId || chat.scrollTop == chat.scrollTopMax)


            chat.insertAdjacentHTML( 'beforeend', writer === myId ? `
            <div class="d-flex justify-content-end">
                <p class="small mb-1 font-weight-bold">${writer}</p>
              </div>
                <div class="d-flex flex-row justify-content-end">

                <div class="mx-1">
                  <p class="own-text-cell small p-2 ms-3 mb-3 rounded-3">${text}</p>
                </div>
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp" alt="avatar 1"
                  style="width: 45px; height: 100%;">

              </div>
            `:`
            <div class="d-flex justify-content-start">

                <p class="small mb-1 font-weight-bold">${writer}</p>
              </div>
              <div class="d-flex flex-row justify-content-start">

                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava2-bg.webp" alt="avatar 2"
                  style="width: 45px; height: 100%;">
                <div class="mx-1">
                    <p class="other-text-cell small p-2 ms-3 mb-3 rounded-3">${text}</p>
                  </div>

              </div>
            `);

            if(autoScroll) chat.scrollTop = chat.scrollTopMax

            //<div class="card-body overflow-auto" style="position: relative; height: 400px">
            /*
            <div class="d-flex justify-content-between">
                <p class="small mb-1 font-weight-bold">Tipa ludopatica</p>
              </div>
              <div class="d-flex flex-row justify-content-start">
                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava1-bg.webp" alt="avatar 1"
                  style="width: 45px; height: 100%;">
                <div class="mx-1">
                  <p class="other-text-cell small p-2 ms-3 mb-3 rounded-3">Vi faccio il culo a tutti!</p>
                </div>
              </div>
            */
        }

        function updateScoreDisplay(scores){

            let div,i=1;

            for (player in scores){
                div = document.querySelector(`#player${i}ScoreDiv`);
                div.innerHTML = `${player},${scores[player]}`
                i++;
            }

        }

        function start_ws() {

            let isValid = false;
            let username = null;
            while(!isValid){
                username = prompt("Please enter your username (only letters and numbers allowed):");
                if (username !== null && username.trim() !== '') {
                    isValid = isValidUsername(username);
                    if (!isValid)
                        alert("Invalid username. Please use only letters and numbers.");
                } else {
                    alert("You must enter a valid username to continue.");
                }
            }

            myId = username;

            socket = io.connect('http://localhost:'+{{SOCKET_PORT}}+'/');

            // WebSocket connection event
            socket.on('connect', function() {
                console.log('Connected to the WebSocket server');

                var connection = { type: "CONNECTION", message: "Hi! I'm " + myId, id: myId};
                var conn = JSON.stringify(connection);
                socket.emit('message', conn);
            });

            // WebSocket message event
            socket.on('message', function(data) {
                mex = JSON.parse(data);
                if(mex.type == "INVALID"){
                    isValid = false;
                    username = null;
                    alert("Username already in use, please use another one");
                    while(!isValid){
                        username = prompt("Please enter your username (only letters and numbers allowed):");
                        if (username !== null && username.trim() !== '') {
                            isValid = isValidUsername(username);
                            if (!isValid)
                                alert("Invalid username. Please use only letters and numbers.");
                        } else {
                            alert("You must enter a valid username to continue.");
                        }
                    }

                    myId = username;

                    var connection = { type: "CONNECTION", message: "Hi! I'm " + myId, id: myId};
                    var conn = JSON.stringify(connection);
                    socket.emit('message', conn);
                } else{
                    if(mex.type == "ROOM"){

                        //document.getElementById("chat").innerHTML += `<div> User ${mex.user} entered your room (ID: ${mex.roomId})</div>`;
                        writeOnChat(`User ${mex.user} entered your room (ID: ${mex.roomId})`,"System")
                        roomId = mex.roomId;
                    } else if(mex.type == "ENTER_ROOM") {
                        //document.getElementById("chat").innerHTML += `<div> You are now in the room (ID: ${mex.roomId})</div>`;
                        writeOnChat(`You are now in the room (ID: ${mex.roomId})`,"System")
                    } else if(mex.type == "START"){
                        //document.getElementById("chat").innerHTML += `<div> STARTING THE GAME</div>`;
                        writeOnChat(`STARTING THE GAME`,"System")
                    } else if(mex.type == "ENDTURN") {
                        //document.getElementById("chat").innerHTML += `<div> THE DRAWN NUMBER IS: ${mex.total}! </div>`;
                        writeOnChat(`THE DRAWN NUMBER IS: ${mex.total}!`,"System")
                        document.getElementById("myRange").setAttribute("max", mex.points[myId]);
                        document.getElementById("myRange2").setAttribute("max", mex.points[myId]);
                        for (let key in mex.points) {
                            if (mex.points.hasOwnProperty(key)) {
                                let value = mex.points[key];
                                //document.getElementById("chat").innerHTML += `<div> Player: ${key} has now: ${value} points!</div>`;
                                writeOnChat(`Player: ${key} has now: ${value} points!`,"System")

                            }
                        }
                        updateScoreDisplay(mex.points)
                        ////document.getElementById("chat").innerHTML += `<div> ${mex.points}</div>`;
                        //writeOnChat("A")
                      } else if(mex.type == "ENDGAME") {
                          let max = 0;
                          let winner;
                          for (let key in mex.points) {
                              if (mex.points.hasOwnProperty(key)) {
                                  let value = mex.points[key];
                                  if (value>=max){
                                    max = value;
                                    winner = key;
                                  }
                              }
                          }
                          document.getElementById("winner").textContent = `WINNER: ${winner}! Total points: ${max}!`;
                      } else{
                        if(mex.id == "all"){
                        //document.getElementById("chat").innerHTML += `<div class="connect-message">${mex.message}</div>`;
                        writeOnChat(`${mex.message}`,"System")
                        }else{
                            //document.getElementById("chat").innerHTML += `<div>${mex.id}: ${mex.message}</div>`;
                            writeOnChat(`${mex.message}`,mex.id)
                        }
                    }
                }

            });

            socket.on('disconnect', function() {
                window.location.href = "http://localhost:3005";
            });

        }

        function send_message(event) {

            let textarea
            let target = event.target;

            if(target.nodeName === "INPUT"){
                textarea = target;
            }else{
                textarea = document.querySelector("#chatCard .card-footer .form-control")
            }


            if (target.nodeName === "BUTTON" || event.key === "Enter") {

                event.preventDefault();
                let text = cleanInput(textarea.value);

                if(text != ""){
                    socket.emit('message', JSON.stringify({ header: [],type: "MESSAGE", message: text, id: myId }));
                }

                textarea.value = "";
            }
        }

        // funzione per pulire l'input (potrebbe servire in futuro)
        function cleanInput(text){
            return text.trim();
        }

        function startAnimation(fileName){
            var myVideo = document.getElementById("diceVideo");
            var source = myVideo.children[0]
            myVideo.pause();

            source.setAttribute('src', `./static/assets/diceAniamtions/${fileName}.webm`);
            source.setAttribute('type', 'video/webm');

            myVideo.load();
            myVideo.play();

            console.log({src: source.getAttribute('src'),type: source.getAttribute('type')});
        }

        function searchRoom() {
            var myButton = document.getElementById("search");
            myButton.setAttribute("disabled", "disabled");
            socket.emit('message', JSON.stringify({ header: [],type: "SEARCHGAME", id: myId }));
        }

        function bet() {
            var slider = document.getElementById("myRange");
            var slider2 = document.getElementById("myRange2");
            placedBet = slider.value;
            placedBet2 = slider2.value;
            socket.emit('message', JSON.stringify({ header: [],type: "GAME_MOVE", "roomId": roomId, "bet": betValue, "placedBet": placedBet, "bet2": betValue2, "placedBet2": placedBet2 }));
            document.getElementById("recap").textContent = 'YOU BET '+placedBet+' OVER '+betValue+'!';
            document.getElementById("recap2").textContent = 'YOU BET '+placedBet2+' OVER '+betValue2+'!';
        }

        function setValue(value) {
            betValue = value;
        }

        function setValue2(value) {
            betValue2 = value;
        }


    </script>
  </head>
  <body onload="start_ws()">

    <div class="container-fluid">
        <div class="row">
          <div class="col-md-6">
            <div class="embed-responsive embed-responsive-16by9 my-5">
              <div class="row" id="video_div">
                <video class="embed-responsive-item" id="diceVideo" width="320" height="240" muted>
                  <source src="./static/assets/diceAnimations/6-6.webm" type="video/webm">
                  <!--<source src="{{ url_for('static', filename="test.mp4") }}" type="video/mp4">-->
                  Your browser does not support the video tag.
                </video>
              </div>
            </div>


          <br>
          <div class="float-container">

            <div class="float-child">
              <div class="evenodd">
                <div class="cell cell-even" onclick="setValue('EVEN')">Even<br>x2</div>
                <div class="cell cell-odd" onclick="setValue('ODD')">Odd<br>x2</div>
              </div>
            </div>

            <div class="float-child">
              <div class="rangediv">
                 <span class="rangevalue" id="rangeValue">0</span>
                 <Input class="range" type="range" name "" value="0" min="0" max="100" onChange="rangeSlide(this.value)" onmousemove="rangeSlide(this.value)" id="myRange"></Input>
               </div>
               <script type="text/javascript">
                  function rangeSlide(value) {
                  document.getElementById('rangeValue').innerHTML = value;
                }
              </script>
            </div>

          </div>


          <div class="float-container">

            <div class="float-child">
              <div class="cellcontainer">
                 <div class="cell cell-1" onclick="setValue2('TWO')">"2"<br>x18</div>
                 <div class="cell cell-2" onclick="setValue2('THREE')">"3"<br>x9</div>
                 <div class="cell cell-3" onclick="setValue2('FOUR')">"4"<br>x6</div>
                 <div class="cell cell-4" onclick="setValue2('FIVE')">"5"<br>x5</div>
                 <div class="cell cell-5" onclick="setValue2('SIX')">"6"<br>x4</div>
                 <div class="cell cell-6" onclick="setValue2('SEVEN')">"7"<br>x3</div>
                 <div class="cell cell-7" onclick="setValue2('EIGHT')">"8"<br>x4</div>
                 <div class="cell cell-8" onclick="setValue2('NINE')">"9"<br>x5</div>
                 <div class="cell cell-9" onclick="setValue2('TEN')">"10"<br>x6</div>
                 <div class="cell cell-10" onclick="setValue2('ELEVEN')">"11"<br>x9</div>
                 <div class="cell cell-11" onclick="setValue2('TWELVE')">"12"<br>x18</div>
               </div>
            </div>

            <div class="float-child">
              <div class="rangediv">
                 <span class="rangevalue" id="rangeValue2">0</span>
                 <Input class="range" type="range" name "" value="0" min="0" max="100" onChange="rangeSlide2(this.value)" onmousemove="rangeSlide2(this.value)" id="myRange2"></Input>
               </div>
               <script type="text/javascript">
                  function rangeSlide2(value) {
                  document.getElementById('rangeValue2').innerHTML = value;
                }
              </script>
            </div>

          </div>





            <br>
            <button id="bet" onclick="bet()">BET!</button>
            <div id="player1ScoreDiv" style="color:white">10</div>
            <div id="player2ScoreDiv" style="color:white">20</div>
            <div id="player3ScoreDiv" style="color:white">30</div>
            <h2 id="recap" style="color:white"></h2>
            <h2 id="recap2" style="color:white"></h2>
            <h2 id="winner" style="color:white"></h2>
          </div>
          <div class="col-md-6 px-5 my-auto">

            <button id="search" onclick="searchRoom()">Search a game room!</button>

            <div id="chatCard" class="card">
              <div class="card-header d-flex justify-content-between align-items-center p-3">
                <h5 class="mb-0 font-weight-bold">Chat</h5>
                <div class="d-flex flex-row align-items-center">
                  <i class="fas fa-minus me-3 text-muted fa-xs"></i>
                  <i class="fas fa-comments me-3 text-muted fa-xs"></i>
                  <i class="fas fa-times text-muted fa-xs"></i>
                </div>
              </div>
              <div class="card-body overflow-auto" style="position: relative; height: 400px"></div>
              <div class="card-footer text-muted d-flex justify-content-start align-items-center p-3">
                <div class="input-group mb-0">
                  <input type="text" class="form-control" placeholder="Type message" onkeypress="send_message(event)"/>
                  <button class="btn" type="button" id="button-addon2" onclick="send_message(event)">
                    Send
                  </button>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
  </body>
</html>
